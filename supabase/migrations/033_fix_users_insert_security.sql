-- ===========================================
-- Migration: Fix Users Insert Security
-- Date: 2024-12
-- Description:
--   セキュリティ問題を修正
--   - 過度に許可的なINSERTポリシーを削除
--   - SECURITY DEFINER関数のみがINSERTできるようにする
-- ===========================================

-- ===========================================
-- 1. 危険なINSERTポリシーを削除
-- ===========================================

-- このポリシーは誰でもusersテーブルにINSERTできてしまうため削除
DROP POLICY IF EXISTS "users_insert_service" ON users;

-- ===========================================
-- 2. 説明
-- ===========================================
-- handle_new_user() 関数は SECURITY DEFINER で実行されるため、
-- RLSポリシーをバイパスしてINSERTできます。
--
-- 一般ユーザーはusersテーブルにINSERTするポリシーがないため、
-- 直接INSERTすることはできません。
--
-- これにより、新規ユーザー作成は auth.users への INSERT 経由の
-- トリガー関数でのみ行われることが保証されます。
-- ===========================================

-- ===========================================
-- 完了
-- ===========================================
